<% form.object.audiences.build if form.object.audiences.empty? %>

<% form.fields_for :audiences do |f| %>
  <% unless f.object.is_a? Group %>

    <fieldset class="filterable list">
      <legend>Jurisdictions</legend>
      <%= jurisdiction_list(f) %>
    </fieldset>
    <fieldset class="filterable list">
      <legend>Limit Roles</legend>
      <ul class="check_selector">
        <%- Role.user_roles.each do |r| -%>
          <li>
            <%- id = [f.object_name.parameterize('_'), dom_id(r)].join('_') -%>
            <%= check_box_tag "#{f.object_name}[role_ids][]", r.id,
                f.object.role_ids.include?(r.id), :id => id %>
            <%= label_tag id, r.name %>
          </li>
        <%- end -%>
      </ul>
    </fieldset>

    <fieldset class="filterable list last">
      <legend>Groups</legend>
      <ul class="check_selector">
        <%- current_user.visible_groups.each do |group| -%>
          <li>
              <%= check_box_tag "#{form.object_name}[audience_ids][]", group.id,
                  form.object.audiences.include?(group),
                  :id => "#{form.object_name}_audience_#{group.id}" %>
              <%= label_tag "#{form.object_name}_audience_#{group.id}", group.name %>
          </li>
        <%- end -%>
      </ul>
    </fieldset>

    <fieldset class="people">
      <legend>People</legend>
      <%- f.object.users.each do |user| -%>
        <%= hidden_field_tag "#{f.object_name}[user_ids][]", user.id %>
      <%- end -%>

      <%= f.select :user_ids, f.object.users.map{|u| [u.name, u.id]}, {}, :multiple => :multiple, :class => "search_user_ids" %>
    </fieldset>
  <% end %>
<% end %>