<% if user.errors.size > 0 %>
  <div id="errorExplanation" class="errorExplanation">
    <% errsize = user.errors['role_requests'].nil? ? user.errors.size : user.errors.size - 1 %>
    <% errsize -= 1 if user.errors["role_requests_jurisdiction"] && user.errors["role_memberships"] %>
    <h2><%= "#{errsize} #{errsize > 1 ? 'errors' : 'error'}"%> prohibited this user from being saved</h2>
    <p>There were problems with the following fields:</p>
  <% user.errors.each do |attr,msg| %>
    <ul>
      <%= case attr
        when "role_requests"
          ""
        when "role_requests_jurisdiction"
          "<li>Home jurisdiction can't be blank</li>" unless user.errors["role_memberships"]
        when "role_memberships"
          "<li>Home jurisdiction can't be blank</li>"
         else
          "<li>#{attr.humanize} #{msg}</li>"
      end %>
    </ul>
  <% end %>
  </div>
<% end %>
  <%= f.label(:first_name, "First Name") %><br/>
  <%= f.text_field(:first_name) %><br/>
  <%= f.label(:last_name, "Last Name") %><br/>
  <%= f.text_field(:last_name) %><br/>
  <%= f.label(:display_name, "Preferred name to be displayed") %><br/>
  <%= f.text_field(:display_name) %><br/>
  <%= f.label(:email, "Email address") %><br/>
  <%= f.text_field(:email) %><br/>
  <%= f.label(:password, "Password") %><br/>
  <%= f.password_field(:password) %><br/>
  <%= f.label(:password_confirmation,"Password Confirmation") %><br/>
  <%= f.password_field(:password_confirmation) %><br/>


  <%= f.label(:preferred_language, "Preferred language") %><br/>
  <%= f.select(:preferred_language, ["English","Spanish"]) %><br/>
  <%= f.label(:title, "Job title") %><br/>
  <%= f.text_field(:title) %><br/>
  
  <% user.role_requests.build if user.role_requests.empty? %>
  <% f.fields_for :role_requests do |r| %>
    <%= r.label :jurisdiction_id,  "Choose your home jurisdiction from the dropdown or checkmark 'Texas' to indicate that your operating jurisdiction is statewide'" %><br/>
    <%= r.collection_select( :jurisdiction_id,  Jurisdiction.state.nonforeign.map{|jurisdiction| jurisdiction.descendants}.flatten.sort_by{|jurisdiction| jurisdiction.name}, :id, :name, {:include_blank => true}, {:class => "home_jurisdiction"}) %><br/>
    <% Jurisdiction.state.nonforeign.each do |jurisdiction| %>
          <%= check_box_tag "user[role_requests_attributes][#{@i.nil? ? @i=1 : @i+=1}][jurisdiction_id]", jurisdiction.id, false, :id => jurisdiction.name, :class => "state_jurisdiction" %>
          <%= f.label "user[role_requests_attributes][#{@i}][jurisdiction_id]", jurisdiction.name %>
    <% end %><br/>
    <%= label_tag "health_professional", "Are you a public health professional?" %>
    <%= check_box_tag "health_professional", 1, params[:health_professional] %>
    <fieldset id='health_professional_fields'>
      <legend>Health Professional Information</legend>
      <%= r.label :role_id, "What is your primary role in public health or emergency response?" %><br/>
      <%= r.collection_select :role_id, Role.user_roles, :id, :name, :include_blank => true %><br/>
      <%= label_tag "user_organizations", "Are you with any of these organizations?" %>
      <%= select_tag "user[organization_ids][]", options_from_collection_for_select(Organization.all.dup.unshift(Organization.new), :id, :name), :id => "user_organizations" %>
      
      <p>
        <%= f.label(:description, "Please describe your role within your organization") %><br/>
        <%= f.text_area(:description, :rows => "8") %><br/>
      </p>
    </fieldset>
  <% end %>
